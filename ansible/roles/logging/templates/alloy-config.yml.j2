// Alloy configuration template
// Generated by Ansible

{% if logs is defined %}
{% for log in logs %}
local.file_match "{{ log.name | replace('-', '_') }}" {
  path_targets = [{
    __address__ = "localhost",
    __path__    = "{{ log.path }}",
    job         = "{{ log.job }}",
    env         = "{{ deployment_environment | default('production') }}",
    host        = "{{ inventory_hostname }}",
    {% if log.type is defined %}
    type        = "{{ log.type }}",
    {% endif %}
    {% if log.labels is defined %}
    {% for label_key, label_value in log.labels.items() %}
    {{ label_key }} = "{{ label_value }}",
    {% endfor %}
    {% endif %}
  }]
}
{% endfor %}
{% else %}
// Fallback to standard configuration
local.file_match "system" {
  path_targets = [{
    __address__ = "localhost",
    __path__    = "{{ log_paths | default('/var/log/*.log') }}",
    job         = "system_logs",
    env         = "{{ deployment_environment | default('production') }}",
    host        = "{{ inventory_hostname }}",
  }]
}
{% endif %}

{% if additional_log_paths is defined %}
{% for path_item in additional_log_paths %}
local.file_match "{{ path_item.name | replace('-', '_') }}" {
  path_targets = [{
    __address__ = "localhost",
    __path__    = "{{ path_item.path }}",
    job         = "{{ path_item.job | default(path_item.name + '_logs') }}",
    env         = "{{ deployment_environment | default('production') }}",
    host        = "{{ inventory_hostname }}",
    {% for label_key, label_value in (path_item.labels | default({})).items() %}
    {{ label_key }} = "{{ label_value }}",
    {% endfor %}
  }]
}
{% endfor %}
{% endif %}

{% if logs is defined %}
{% for log in logs %}
loki.source.file "{{ log.name | replace('-', '_') }}" {
  targets    = local.file_match.{{ log.name | replace('-', '_') }}.targets
  forward_to = [loki.write.default.receiver]
}
{% endfor %}
{% else %}
{% for log_group in log_groups | default(['system']) %}
loki.source.file "{{ log_group | replace('-', '_') }}" {
  targets    = local.file_match.{{ log_group | replace('-', '_') }}.targets
  forward_to = [loki.write.default.receiver]
}
{% endfor %}
{% endif %}

loki.write "default" {
  endpoint {
    url = "{{ loki_url }}"
    {% if loki_username is defined and loki_password is defined %}
    basic_auth {
      username = "{{ loki_username }}"
      password = "{{ loki_password }}"
    }
    {% endif %}
    {% if loki_tenant_id is defined %}
    tenant_id = "{{ loki_tenant_id }}"
    {% endif %}
  }
  external_labels = {
    env = "{{ deployment_environment | default('production') }}",
    host = "{{ inventory_hostname }}",
    {% if additional_labels is defined %}
    {% for label_key, label_value in additional_labels.items() %}
    {{ label_key }} = "{{ label_value }}",
    {% endfor %}
    {% endif %}
  }
}