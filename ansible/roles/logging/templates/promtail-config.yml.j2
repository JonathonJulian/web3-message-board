---
# Promtail configuration file
# Generated by Ansible

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /var/lib/promtail/positions.yaml

clients:
  - url: {{ loki_url }}

scrape_configs:
{% if logs is defined %}
  # Use logs format from global vars
{% for log in logs %}
  - job_name: {{ log.job }}
    static_configs:
      - targets:
          - localhost
        labels:
          job: {{ log.job }}
          host: {{ inventory_hostname }}
          __path__: {{ log.path }}
          {% if log.type is defined %}
          type: {{ log.type }}
          {% endif %}
          {% if log.labels is defined %}
          {% for label_key, label_value in log.labels.items() %}
          {{ label_key }}: {{ label_value }}
          {% endfor %}
          {% endif %}
{% endfor %}
{% else %}
  # Fallback to standard configuration
  - job_name: system
    static_configs:
      - targets:
          - localhost
        labels:
          job: system_logs
          host: {{ inventory_hostname }}
          __path__: {{ log_paths | default('/var/log/*.log') }}
{% endif %}

{% if additional_log_paths is defined %}
{% for path_item in additional_log_paths %}
  - job_name: {{ path_item.job | default(path_item.name + '_logs') }}
    static_configs:
      - targets:
          - localhost
        labels:
          job: {{ path_item.job | default(path_item.name + '_logs') }}
          host: {{ inventory_hostname }}
          __path__: {{ path_item.path }}
          {% if path_item.labels is defined %}
          {% for label_key, label_value in path_item.labels.items() %}
          {{ label_key }}: {{ label_value }}
          {% endfor %}
          {% endif %}
{% endfor %}
{% endif %}
